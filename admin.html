<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡ç³»çµ±</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #0d3d0d 0%, #1a5d1a 50%, #0d3d0d 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #2e8b2e;
        }
        .header h1 {
            color: #90EE90;
            font-size: 28px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 25px;
            background: rgba(0,0,0,0.4);
            border: 2px solid #2e8b2e;
            border-radius: 8px;
            color: #90EE90;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            background: rgba(46, 139, 46, 0.3);
        }
        .tab-btn.active {
            background: #2e8b2e;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #2e8b2e;
        }
        .phase-display {
            font-size: 18px;
        }
        .phase-display .phase {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .phase.stop { background: #e74c3c; }
        .phase.betting { background: #27ae60; }
        .phase.spinning { background: #f39c12; }
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #90EE90;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #2e8b2e;
        }
        .panel h2 {
            color: #90EE90;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(144,238,144,0.3);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-item .label {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #90EE90;
        }
        .summary-item .value.positive { color: #27ae60; }
        .summary-item .value.negative { color: #e74c3c; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(0,0,0,0.3);
            color: #90EE90;
        }
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .online-status.online { background: #27ae60; }
        .online-status.offline { background: #7f8c8d; }
        .recharge-form {
            display: grid;
            gap: 15px;
            max-width: 400px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #90EE90;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #2e8b2e;
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-primary {
            background: #2e8b2e;
            color: white;
        }
        .btn-primary:hover {
            background: #3a9f3a;
        }
        .btn-secondary {
            background: #495057;
            color: white;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-bar select {
            padding: 8px 15px;
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #2e8b2e;
            color: white;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card .stat-label {
            font-size: 14px;
            color: #adb5bd;
            margin-bottom: 5px;
        }
        .stat-card .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #90EE90;
        }
        .stat-card .stat-value.positive { color: #51cf66; }
        .stat-card .stat-value.negative { color: #ff6b6b; }
        .records-table {
            max-height: 500px;
            overflow-y: auto;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }
        .connection-dot.connected {
            background: #27ae60;
        }
        .profit-value.positive { color: #51cf66; }
        .profit-value.negative { color: #ff6b6b; }
        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .message.success {
            background: rgba(39, 174, 96, 0.3);
            border: 1px solid #27ae60;
            color: #27ae60;
        }
        .message.error {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ° ç®¡ç†å“¡ç³»çµ±</h1>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('realtime')">ğŸ“Š å³æ™‚ç›£æ§</button>
        <button class="tab-btn" onclick="switchTab('recharge')">ğŸ’° æœƒå“¡å……å€¼</button>
        <button class="tab-btn" onclick="switchTab('records')">ğŸ“‹ æŠ¼æ³¨è¨˜éŒ„</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“ˆ æç›Šçµ±è¨ˆ</button>
    </div>

    <div class="status-bar">
        <div class="connection-status">
            <div class="connection-dot" id="connectionDot"></div>
            <span id="connectionText">é€£ç·šä¸­...</span>
        </div>
        <div class="phase-display">
            éŠæˆ²ç‹€æ…‹: <span class="phase" id="gamePhase">--</span>
        </div>
        <div>
            æœŸæ•¸: <span id="roundNumber">--</span>
        </div>
        <div class="timer">
            <span id="timerDisplay">--</span> ç§’
        </div>
    </div>

    <!-- å³æ™‚ç›£æ§ -->
    <div id="tab-realtime" class="tab-content active">
        <div class="summary-grid">
            <div class="summary-item">
                <div class="label">æœ¬å±€ç¸½æŠ•æ³¨</div>
                <div class="value" id="totalBets">$0</div>
            </div>
            <div class="summary-item">
                <div class="label">æŠ•æ³¨äººæ•¸</div>
                <div class="value" id="totalPlayers">0</div>
            </div>
            <div class="summary-item">
                <div class="label">ä¸Šå±€é–‹ç</div>
                <div id="lastNumberBall" style="display:flex; justify-content:center; align-items:center;">
                    <div class="number-ball" id="lastNumber" style="width:60px; height:60px; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:24px; font-weight:bold; color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,0.5); box-shadow: inset -3px -3px 8px rgba(0,0,0,0.3), inset 3px 3px 8px rgba(255,255,255,0.2), 0 4px 8px rgba(0,0,0,0.3);">--</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>ğŸ“Š å³æ™‚æŠ¼æ³¨æ˜ç´°</h2>
                <div id="betsDisplay">
                    <h3 style="color:#90EE90; margin-bottom:10px;">å–®é›™æŠ•æ³¨</h3>
                    <table>
                        <tr><td>å–®</td><td id="oddTotal">$0</td></tr>
                        <tr><td>é›™</td><td id="evenTotal">$0</td></tr>
                    </table>
                    <h3 style="color:#90EE90; margin:15px 0 10px;">å¤§å°æŠ•æ³¨</h3>
                    <table>
                        <tr><td>å¤§ (20-38)</td><td id="bigTotal">$0</td></tr>
                        <tr><td>å° (1-19)</td><td id="smallTotal">$0</td></tr>
                    </table>
                    <h3 style="color:#90EE90; margin:15px 0 10px;">é¡è‰²æŠ•æ³¨ (1è³ 1.8)</h3>
                    <table>
                        <tr><td><span style="color:#DC143C;">ç´…</span> (2,5,8,11,14...)</td><td id="redTotal">$0</td></tr>
                        <tr><td><span style="color:#4169E1;">è—</span> (3,6,9,12,15...)</td><td id="blueTotal">$0</td></tr>
                        <tr><td><span style="color:#228B22;">ç¶ </span> (1,4,7,10,13...)</td><td id="greenTotal">$0</td></tr>
                    </table>
                    <h3 style="color:#90EE90; margin:15px 0 10px;">è™Ÿç¢¼æŠ•æ³¨åˆ†å¸ƒ</h3>
                    <div id="numberBetsGrid" style="display:grid; grid-template-columns:repeat(10, 1fr); gap:4px; font-size:11px;"></div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ‘¥ æœƒå“¡åˆ—è¡¨</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ç‹€æ…‹</th>
                            <th>å¸³è™Ÿ</th>
                            <th>å§“å</th>
                            <th>é¤˜é¡</th>
                        </tr>
                    </thead>
                    <tbody id="memberTable">
                        <tr><td colspan="4" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡å……å€¼ -->
    <div id="tab-recharge" class="tab-content">
        <div class="main-content">
            <div class="panel">
                <h2>ğŸ’° æœƒå“¡å……å€¼</h2>
                <div id="rechargeMessage"></div>
                <div class="recharge-form">
                    <div class="form-group">
                        <label>é¸æ“‡æœƒå“¡</label>
                        <select id="rechargeMember">
                            <option value="">-- è«‹é¸æ“‡æœƒå“¡ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å……å€¼é‡‘é¡</label>
                        <input type="number" id="rechargeAmount" placeholder="è¼¸å…¥é‡‘é¡" min="100" step="100">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="rechargeRemark" rows="2" placeholder="é¸å¡«"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="doRecharge()">ç¢ºèªå……å€¼</button>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ“‹ å……å€¼è¨˜éŒ„</h2>
                <div class="filter-bar">
                    <select id="rechargeFilterDays" onchange="loadRechargeRecords()">
                        <option value="1">ä»Šå¤©</option>
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="14" selected>æœ€è¿‘14å¤©</option>
                    </select>
                </div>
                <div class="records-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ™‚é–“</th>
                                <th>æœƒå“¡</th>
                                <th>é‡‘é¡</th>
                                <th>è®Šå‹•å‰</th>
                                <th>è®Šå‹•å¾Œ</th>
                            </tr>
                        </thead>
                        <tbody id="rechargeRecordsTable">
                            <tr><td colspan="5" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ¼æ³¨è¨˜éŒ„ -->
    <div id="tab-records" class="tab-content">
        <div class="panel">
            <h2>ğŸ“‹ æŠ¼æ³¨è¨˜éŒ„æŸ¥è©¢</h2>
            <div class="filter-bar">
                <select id="recordsFilterDays" onchange="loadBetRecords()">
                    <option value="1">ä»Šå¤©</option>
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="14" selected>æœ€è¿‘14å¤©</option>
                </select>
                <select id="recordsFilterMember" onchange="loadBetRecords()">
                    <option value="">å…¨éƒ¨æœƒå“¡</option>
                </select>
                <button class="btn btn-secondary" onclick="loadBetRecords()">åˆ·æ–°</button>
            </div>
            <div class="records-table">
                <table>
                    <thead>
                        <tr>
                            <th>æœŸæ•¸</th>
                            <th>æ™‚é–“</th>
                            <th>æœƒå“¡</th>
                            <th>é¡å‹</th>
                            <th>ç›®æ¨™</th>
                            <th>é‡‘é¡</th>
                            <th>é–‹ç</th>
                            <th>æç›Š</th>
                        </tr>
                    </thead>
                    <tbody id="betRecordsTable">
                        <tr><td colspan="8" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æç›Šçµ±è¨ˆ -->
    <div id="tab-stats" class="tab-content">
        <div class="filter-bar">
            <select id="statsFilterDays" onchange="loadStats()">
                <option value="1">ä»Šå¤©</option>
                <option value="7">æœ€è¿‘7å¤©</option>
                <option value="14" selected>æœ€è¿‘14å¤©</option>
            </select>
        </div>
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-label">ç¸½å±€æ•¸</div>
                <div class="stat-value" id="statRounds">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¸½æŠ•æ³¨é¡</div>
                <div class="stat-value" id="statTotalBets">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¸½æ´¾å½©</div>
                <div class="stat-value" id="statTotalPayout">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç³»çµ±æ·¨åˆ©</div>
                <div class="stat-value" id="statProfit">$0</div>
            </div>
        </div>

        <div class="panel">
            <h2>ğŸ“ˆ é–‹çè¨˜éŒ„</h2>
            <div class="records-table">
                <table>
                    <thead>
                        <tr>
                            <th>æœŸæ•¸</th>
                            <th>æ™‚é–“</th>
                            <th>é–‹çè™Ÿç¢¼</th>
                            <th>ç¸½æŠ•æ³¨</th>
                            <th>ç¸½æ´¾å½©</th>
                            <th>ç³»çµ±æç›Š</th>
                        </tr>
                    </thead>
                    <tbody id="gameResultsTable">
                        <tr><td colspan="6" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let mqttClient;
        let bets = {};
        let oddEvenBets = { odd: { total: 0, players: [] }, even: { total: 0, players: [] } };
        let bigSmallBets = { big: { total: 0, players: [] }, small: { total: 0, players: [] } };
        let colorBets = { red: { total: 0, players: [] }, blue: { total: 0, players: [] }, green: { total: 0, players: [] } };
        let onlinePlayers = new Set();
        let allMembers = [];
        let lastWinningNumber = null;

        const MQTT_BROKER = 'wss://tw5399.com:9002';
        const CLIENT_ID = 'admin_' + Math.random().toString(16).substr(2, 8);

        // é »é“è¨­å®šï¼ˆç”±ä¼ºæœå™¨æ³¨å…¥ï¼‰
        const CHANNEL_ID = window.CHANNEL_ID || 'local';
        const CHANNEL_PREFIX = `roulette/${CHANNEL_ID}`;
        console.log('ç³»çµ±é »é“:', CHANNEL_ID);

        // åˆ‡æ›åˆ†é 
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            // åˆ‡æ›æ™‚è¼‰å…¥è³‡æ–™
            if (tabId === 'records') loadBetRecords();
            if (tabId === 'stats') loadStats();
            if (tabId === 'recharge') loadRechargeRecords();
        }

        // é€£æ¥ MQTT
        function connectMQTT() {
            mqttClient = mqtt.connect(MQTT_BROKER, {
                username: 'palee',
                password: '888168',
                clientId: CLIENT_ID,
                clean: true,
                reconnectPeriod: 3000
            });

            mqttClient.on('connect', () => {
                console.log('MQTT é€£ç·šæˆåŠŸ');
                document.getElementById('connectionDot').classList.add('connected');
                document.getElementById('connectionText').textContent = 'MQTT å·²é€£ç·š';

                mqttClient.subscribe([
                    `${CHANNEL_PREFIX}/game/state`,
                    `${CHANNEL_PREFIX}/game/result`,
                    `${CHANNEL_PREFIX}/bets/update`,
                    `${CHANNEL_PREFIX}/admin/data`,
                    `${CHANNEL_PREFIX}/admin/query/response/${CLIENT_ID}`,
                    `${CHANNEL_PREFIX}/admin/recharge/response/${CLIENT_ID}`
                ]);

                mqttClient.publish(`${CHANNEL_PREFIX}/client/connect`, JSON.stringify({ clientId: CLIENT_ID, type: 'admin' }));
            });

            mqttClient.on('message', (topic, message) => {
                try {
                    const data = JSON.parse(message.toString());
                    handleMessage(topic, data);
                } catch (error) {
                    console.error('è™•ç†è¨Šæ¯éŒ¯èª¤:', error);
                }
            });

            mqttClient.on('close', () => {
                document.getElementById('connectionDot').classList.remove('connected');
                document.getElementById('connectionText').textContent = 'é€£ç·šä¸­æ–·ï¼Œé‡æ–°é€£ç·šä¸­...';
            });
        }

        function handleMessage(topic, data) {
            if (topic === `${CHANNEL_PREFIX}/game/state`) {
                updatePhaseDisplay(data.phase, data.seconds);
                if (data.roundNumber) {
                    document.getElementById('roundNumber').textContent = data.roundNumber;
                }
                return;
            }

            if (topic === `${CHANNEL_PREFIX}/game/result`) {
                if (data.type === 'game_result' && data.result) {
                    lastWinningNumber = data.result.winningNumber;
                    updateLastNumberBall(lastWinningNumber);
                }
                return;
            }

            if (topic === `${CHANNEL_PREFIX}/bets/update` || topic === `${CHANNEL_PREFIX}/admin/data`) {
                if (data.bets) bets = data.bets;
                if (data.oddEvenBets) oddEvenBets = data.oddEvenBets;
                if (data.bigSmallBets) bigSmallBets = data.bigSmallBets;
                if (data.colorBets) colorBets = data.colorBets;
                if (data.members) {
                    allMembers = data.members;
                    updateMemberSelect();
                }
                if (data.onlinePlayers) {
                    onlinePlayers = new Set(data.onlinePlayers);
                }
                updateBetsDisplay();
                updateMemberTable();
                return;
            }

            if (topic === `${CHANNEL_PREFIX}/admin/query/response/${CLIENT_ID}`) {
                handleQueryResponse(data);
                return;
            }

            if (topic === `${CHANNEL_PREFIX}/admin/recharge/response/${CLIENT_ID}`) {
                handleRechargeResponse(data);
                return;
            }
        }

        function updatePhaseDisplay(phase, seconds) {
            const phaseElement = document.getElementById('gamePhase');
            const timerElement = document.getElementById('timerDisplay');

            phaseElement.className = 'phase ' + phase;
            const phaseNames = { 'stop': 'çµç®—ä¸­', 'betting': 'é–‹æ”¾ä¸‹æ³¨', 'spinning': 'åœæ­¢ä¸‹æ³¨' };
            phaseElement.textContent = phaseNames[phase] || phase;
            if (seconds !== undefined) timerElement.textContent = seconds;
        }

        function updateLastNumberBall(num) {
            const ball = document.getElementById('lastNumber');
            ball.textContent = num;

            // æ ¹æ“šè™Ÿç¢¼è¨­å®šé¡è‰²ï¼ˆ0=è—, 1=ç¶ , 2=ç´…ï¼‰
            const n = parseInt(num);
            const colorIndex = n % 3;
            let bgColor;
            if (colorIndex === 0) bgColor = '#4169E1'; // è— (3,6,9,12...)
            else if (colorIndex === 1) bgColor = '#228B22'; // ç¶  (1,4,7,10...)
            else bgColor = '#DC143C'; // ç´… (2,5,8,11,14...)

            ball.style.background = `radial-gradient(circle at 30% 30%, ${bgColor}, ${adjustColor(bgColor, -40)})`;
        }

        function adjustColor(hex, amount) {
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function updateBetsDisplay() {
            let totalAmount = 0;
            let playerSet = new Set();

            for (let num in bets) {
                totalAmount += bets[num].total;
                bets[num].players.forEach(p => playerSet.add(p.id));
            }

            document.getElementById('oddTotal').textContent = '$' + oddEvenBets.odd.total.toLocaleString();
            document.getElementById('evenTotal').textContent = '$' + oddEvenBets.even.total.toLocaleString();
            document.getElementById('bigTotal').textContent = '$' + bigSmallBets.big.total.toLocaleString();
            document.getElementById('smallTotal').textContent = '$' + bigSmallBets.small.total.toLocaleString();
            document.getElementById('redTotal').textContent = '$' + colorBets.red.total.toLocaleString();
            document.getElementById('blueTotal').textContent = '$' + colorBets.blue.total.toLocaleString();
            document.getElementById('greenTotal').textContent = '$' + colorBets.green.total.toLocaleString();

            totalAmount += oddEvenBets.odd.total + oddEvenBets.even.total;
            totalAmount += bigSmallBets.big.total + bigSmallBets.small.total;
            totalAmount += colorBets.red.total + colorBets.blue.total + colorBets.green.total;

            oddEvenBets.odd.players.forEach(p => playerSet.add(p.id));
            oddEvenBets.even.players.forEach(p => playerSet.add(p.id));
            bigSmallBets.big.players.forEach(p => playerSet.add(p.id));
            bigSmallBets.small.players.forEach(p => playerSet.add(p.id));
            colorBets.red.players.forEach(p => playerSet.add(p.id));
            colorBets.blue.players.forEach(p => playerSet.add(p.id));
            colorBets.green.players.forEach(p => playerSet.add(p.id));

            document.getElementById('totalBets').textContent = '$' + totalAmount.toLocaleString();
            document.getElementById('totalPlayers').textContent = playerSet.size;

            // è™Ÿç¢¼æŠ•æ³¨åˆ†å¸ƒï¼ˆç«‹é«”çƒæ•ˆæœï¼‰
            const grid = document.getElementById('numberBetsGrid');
            let gridHtml = '';
            const colors = ['#4169E1', '#228B22', '#DC143C']; // è—ã€ç¶ ã€ç´…
            const darkColors = ['#2a4a9e', '#166b16', '#a01030']; // æš—è‰²ç‰ˆæœ¬
            for (let i = 1; i <= 39; i++) {
                const num = i.toString().padStart(2, '0');
                const betData = bets[num] || { total: 0, players: [] };
                const colorIndex = i % 3;
                const hasBet = betData.total > 0;
                const baseColor = colors[colorIndex];
                const darkColor = darkColors[colorIndex];
                const ballStyle = hasBet
                    ? `background: radial-gradient(circle at 30% 30%, ${lightenColor(baseColor, 30)}, ${baseColor} 50%, ${darkColor}); box-shadow: inset -2px -2px 6px rgba(0,0,0,0.4), inset 2px 2px 6px rgba(255,255,255,0.3), 0 3px 6px rgba(0,0,0,0.4), 0 0 10px ${baseColor}80;`
                    : `background: radial-gradient(circle at 30% 30%, #555, #333 50%, #1a1a1a); box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3), inset 1px 1px 3px rgba(255,255,255,0.1);`;
                const border = hasBet ? '2px solid #FFD700' : '1px solid #444';
                gridHtml += `<div style="display:flex; flex-direction:column; align-items:center; padding:4px;">
                    <div style="width:32px; height:32px; border-radius:50%; ${ballStyle} border:${border}; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:11px; color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,0.8);">${num}</div>
                    <div style="color:${hasBet ? '#FFD700' : '#666'}; font-size:9px; margin-top:2px;">${hasBet ? '$' + betData.total.toLocaleString() : '-'}</div>
                </div>`;
            }
            grid.innerHTML = gridHtml;
        }

        function lightenColor(hex, percent) {
            const num = parseInt(hex.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + (R << 16) + (G << 8) + B).toString(16).slice(1);
        }

        function updateMemberTable() {
            const tbody = document.getElementById('memberTable');
            if (allMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>';
                return;
            }

            tbody.innerHTML = allMembers.map(member => {
                const isOnline = onlinePlayers.has(member.id);
                return `
                    <tr>
                        <td><span class="online-status ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'åœ¨ç·š' : 'é›¢ç·š'}</td>
                        <td>${member.username}</td>
                        <td>${member.name}</td>
                        <td>$${member.balance.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateMemberSelect() {
            const select1 = document.getElementById('rechargeMember');
            const select2 = document.getElementById('recordsFilterMember');

            const options = allMembers.map(m => `<option value="${m.id}">${m.username} - ${m.name}</option>`).join('');

            select1.innerHTML = '<option value="">-- è«‹é¸æ“‡æœƒå“¡ --</option>' + options;
            select2.innerHTML = '<option value="">å…¨éƒ¨æœƒå“¡</option>' + options;
        }

        // å……å€¼åŠŸèƒ½
        function doRecharge() {
            const memberId = document.getElementById('rechargeMember').value;
            const amount = parseInt(document.getElementById('rechargeAmount').value);
            const remark = document.getElementById('rechargeRemark').value;

            if (!memberId) {
                showMessage('rechargeMessage', 'è«‹é¸æ“‡æœƒå“¡', 'error');
                return;
            }
            if (!amount || amount <= 0) {
                showMessage('rechargeMessage', 'è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error');
                return;
            }

            mqttClient.publish(`${CHANNEL_PREFIX}/admin/recharge`, JSON.stringify({
                memberId: parseInt(memberId),
                amount: amount,
                operator: 'admin',
                remark: remark,
                requestId: CLIENT_ID
            }));
        }

        function handleRechargeResponse(data) {
            if (data.success) {
                showMessage('rechargeMessage', 'å……å€¼æˆåŠŸï¼', 'success');
                document.getElementById('rechargeAmount').value = '';
                document.getElementById('rechargeRemark').value = '';
                loadRechargeRecords();
            } else {
                showMessage('rechargeMessage', 'å……å€¼å¤±æ•—ï¼š' + data.message, 'error');
            }
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        // æŸ¥è©¢åŠŸèƒ½
        let pendingQueryType = null;

        function loadBetRecords() {
            const days = document.getElementById('recordsFilterDays').value;
            const memberId = document.getElementById('recordsFilterMember').value;

            pendingQueryType = 'betRecords';

            mqttClient.publish(`${CHANNEL_PREFIX}/admin/query`, JSON.stringify({
                queryType: memberId ? 'memberBetRecords' : 'betRecords',
                params: { days: parseInt(days), memberId: memberId ? parseInt(memberId) : null },
                requestId: CLIENT_ID
            }));
        }

        function loadRechargeRecords() {
            const days = document.getElementById('rechargeFilterDays').value;
            pendingQueryType = 'rechargeRecords';

            mqttClient.publish(`${CHANNEL_PREFIX}/admin/query`, JSON.stringify({
                queryType: 'rechargeRecords',
                params: { days: parseInt(days) },
                requestId: CLIENT_ID
            }));
        }

        function loadStats() {
            const days = document.getElementById('statsFilterDays').value;
            pendingQueryType = 'stats';

            mqttClient.publish(`${CHANNEL_PREFIX}/admin/query`, JSON.stringify({
                queryType: 'systemStats',
                params: { days: parseInt(days) },
                requestId: CLIENT_ID
            }));

            setTimeout(() => {
                mqttClient.publish(`${CHANNEL_PREFIX}/admin/query`, JSON.stringify({
                    queryType: 'gameResults',
                    params: { days: parseInt(days) },
                    requestId: CLIENT_ID
                }));
            }, 100);
        }

        function handleQueryResponse(data) {
            if (Array.isArray(data)) {
                if (data.length > 0 && data[0].bet_type) {
                    renderBetRecords(data);
                } else if (data.length > 0 && data[0].balance_before !== undefined) {
                    renderRechargeRecords(data);
                } else if (data.length > 0 && data[0].winning_number !== undefined) {
                    renderGameResults(data);
                } else if (data.length === 0) {
                    if (pendingQueryType === 'betRecords') {
                        document.getElementById('betRecordsTable').innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;">æš«ç„¡è¨˜éŒ„</td></tr>';
                    } else if (pendingQueryType === 'rechargeRecords') {
                        document.getElementById('rechargeRecordsTable').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">æš«ç„¡è¨˜éŒ„</td></tr>';
                    }
                }
            } else if (data.totalRounds !== undefined) {
                document.getElementById('statRounds').textContent = data.totalRounds;
                document.getElementById('statTotalBets').textContent = '$' + (data.totalBets || 0).toLocaleString();
                document.getElementById('statTotalPayout').textContent = '$' + (data.totalPayout || 0).toLocaleString();
                const profitEl = document.getElementById('statProfit');
                const profit = data.totalProfit || 0;
                profitEl.textContent = (profit >= 0 ? '+' : '') + '$' + profit.toLocaleString();
                profitEl.className = 'stat-value ' + (profit >= 0 ? 'positive' : 'negative');
            }
        }

        function renderBetRecords(records) {
            const tbody = document.getElementById('betRecordsTable');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;">æš«ç„¡è¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(r => {
                let targetText = r.bet_target;
                if (r.bet_type === 'oddeven') targetText = r.bet_target === 'odd' ? 'å–®' : 'é›™';
                else if (r.bet_type === 'bigsmall') targetText = r.bet_target === 'big' ? 'å¤§' : 'å°';

                const typeText = { 'number': 'è™Ÿç¢¼', 'oddeven': 'å–®é›™', 'bigsmall': 'å¤§å°' }[r.bet_type] || r.bet_type;

                let profitText = '--';
                let profitClass = '';
                if (r.profit !== null) {
                    profitText = (r.profit >= 0 ? '+' : '') + '$' + r.profit.toLocaleString();
                    profitClass = r.profit >= 0 ? 'positive' : 'negative';
                }

                const time = new Date(r.created_at).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });

                return `
                    <tr>
                        <td>${r.round_number}</td>
                        <td>${time}</td>
                        <td>${r.member_name || r.username || '--'}</td>
                        <td>${typeText}</td>
                        <td>${targetText}</td>
                        <td>$${r.amount.toLocaleString()}</td>
                        <td>${r.winning_number || '--'}</td>
                        <td class="profit-value ${profitClass}">${profitText}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderRechargeRecords(records) {
            const tbody = document.getElementById('rechargeRecordsTable');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">æš«ç„¡è¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(r => {
                const time = new Date(r.created_at).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
                return `
                    <tr>
                        <td>${time}</td>
                        <td>${r.member_name || r.username}</td>
                        <td class="profit-value positive">+$${r.amount.toLocaleString()}</td>
                        <td>$${r.balance_before.toLocaleString()}</td>
                        <td>$${r.balance_after.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderGameResults(records) {
            const tbody = document.getElementById('gameResultsTable');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;">æš«ç„¡è¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(r => {
                const time = new Date(r.created_at).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
                const profitClass = r.system_profit >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${r.round_number}</td>
                        <td>${time}</td>
                        <td style="font-weight:bold;color:#90EE90;">${r.winning_number}</td>
                        <td>$${r.total_bets.toLocaleString()}</td>
                        <td>$${r.total_payout.toLocaleString()}</td>
                        <td class="profit-value ${profitClass}">${r.system_profit >= 0 ? '+' : ''}$${r.system_profit.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // å•Ÿå‹•
        connectMQTT();
    </script>
</body>
</html>
